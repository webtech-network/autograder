<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Create Configuration - Autograder</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="page-container">
        <header class="page-header">
            <h1>‚öôÔ∏è Create Grading Configuration</h1>
            <a href="index.html" class="back-link">‚Üê Back to Dashboard</a>
        </header>

        <div class="page-content">
            <div class="grid-sidebar">
                <!-- Left: Configuration Form -->
                <div class="panel">
                    <div class="panel-header">Configuration Settings</div>
                    <div class="panel-content">
                        <label>Assignment ID</label>
                        <input type="text" id="assignmentId" value="io-calc-001" placeholder="Unique assignment identifier">

                        <label>Criteria Template</label>
                        <select id="criteriaTemplate" onchange="updatePreview()">
                            <option value="1">1 - Base Only (Simple)</option>
                            <option value="2">2 - Base + Bonus</option>
                            <option value="3">3 - Base + Bonus + Penalty</option>
                            <option value="4">4 - With Subjects</option>
                            <option value="5" selected>5 - Nested Subjects (Complex)</option>
                        </select>
                        <p class="text-muted text-small mb-2" id="templateDescription"></p>

                        <label>Programming Language</label>
                        <select id="language" onchange="updatePreview()">
                            <option value="python" selected>Python</option>
                            <option value="java">Java</option>
                            <option value="javascript">JavaScript (Node.js)</option>
                            <option value="cpp">C++</option>
                        </select>

                        <hr>

                        <button class="success" onclick="createConfig()">
                            Create Configuration
                        </button>

                        <div id="createResult" class="mt-2"></div>
                    </div>
                </div>

                <!-- Right: Preview -->
                <div>
                    <!-- Tree Preview -->
                    <div class="panel mb-3">
                        <div class="panel-header">üìä Criteria Tree Preview</div>
                        <div class="panel-content">
                            <div class="tree" id="treePreview"></div>
                        </div>
                    </div>

                    <!-- JSON Preview -->
                    <div class="panel mb-3">
                        <div class="panel-header">
                            üìù JSON Configuration
                            <button class="btn-small" style="float: right; width: auto; margin: 0; padding: 0.25rem 0.5rem;" onclick="copyJson()">Copy</button>
                        </div>
                        <div class="panel-content">
                            <textarea id="jsonPreview" rows="12" style="margin-bottom: 0;"></textarea>
                        </div>
                    </div>

                    <!-- API Response -->
                    <div class="panel">
                        <div class="panel-header">API Response</div>
                        <div class="panel-content">
                            <div id="apiResponseInfo" class="response-info mb-2">
                                <span class="status-code">---</span>
                                <span class="response-time">---</span>
                            </div>
                            <div class="json-box" id="apiResponse" style="min-height: 150px;">
                                Create a configuration to see the API response...
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="shared.js?v=4"></script>
    <script>
        function updatePreview() {
            const templateId = document.getElementById('criteriaTemplate').value;
            const language = document.getElementById('language').value;

            // Update description
            const template = criteriaTemplates[templateId];
            document.getElementById('templateDescription').textContent = template.description;

            // Get criteria with proper command
            const criteria = getCriteriaWithCommand(templateId, language);
            const setupConfig = setupConfigs[language];

            // Update tree preview
            document.getElementById('treePreview').innerHTML = renderTree(criteria);

            // Update JSON preview with full config including setup_config
            const fullConfig = {
                criteria_config: criteria,
                setup_config: setupConfig
            };
            document.getElementById('jsonPreview').value = JSON.stringify(fullConfig, null, 2);
        }

        async function createConfig() {
            const assignmentId = document.getElementById('assignmentId').value;
            const templateId = document.getElementById('criteriaTemplate').value;
            const language = document.getElementById('language').value;
            const criteria = getCriteriaWithCommand(templateId, language);
            const setupConfig = setupConfigs[language];

            const result = await apiCall('/api/v1/configs', 'POST', {
                external_assignment_id: assignmentId,
                template_name: 'input_output',
                criteria_config: criteria,
                language: language,
                setup_config: setupConfig
            });

            // Show API response
            document.getElementById('apiResponseInfo').innerHTML = `
                <span class="status-code ${result.ok ? 'success' : 'error'}">${result.status || 'ERR'}</span>
                <span class="response-time">${result.duration}ms</span>
            `;
            document.getElementById('apiResponse').textContent = JSON.stringify(result.data, null, 2);

            const resultDiv = document.getElementById('createResult');
            if (result.ok) {
                resultDiv.innerHTML = `<div class="badge completed">‚úì Created! ID: ${result.data.id}</div>`;
            } else {
                resultDiv.innerHTML = `<div class="badge failed">‚úó ${result.data.detail || 'Error'}</div>`;
            }
        }

        function copyJson() {
            const textarea = document.getElementById('jsonPreview');
            textarea.select();
            document.execCommand('copy');
            alert('JSON copied to clipboard!');
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            loadApiUrl();
            updatePreview();
        });
    </script>
</body>
</html>

